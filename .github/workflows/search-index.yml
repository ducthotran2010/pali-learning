name: Update Search Index

on:
  push:
    branches:
      - main
    paths:
      - '_includes/pali/*/vocab.md'
      - '_includes/pali/verbs-*/example.md'
      - '_plugins/search_index_generator.rb'

jobs:
  update-search-index:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 2  # Need history to compare changes

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Install dependencies
        run: bundle install

      - name: Build Jekyll site and generate search index
        run: |
          bundle exec jekyll build --trace
          echo "âœ… Jekyll build completed"

      - name: Read search summary
        id: summary
        run: |
          if [ -f "_site/search-summary.json" ]; then
            # Extract summary data
            TOTAL_WORDS=$(jq -r '.total_words' _site/search-summary.json)
            SECTIONS=$(jq -r '.sections_updated | join(", ")' _site/search-summary.json)

            echo "total_words=$TOTAL_WORDS" >> $GITHUB_OUTPUT
            echo "sections=$SECTIONS" >> $GITHUB_OUTPUT

            # Check for changes
            if [ -f "assets/search-data.json" ]; then
              CHANGES=$(jq -r '.changes.added // 0' _site/search-summary.json)
              NEW_WORDS=$(jq -r '.changes.new_words // [] | join(", ")' _site/search-summary.json)
              echo "changes=$CHANGES" >> $GITHUB_OUTPUT
              echo "new_words=$NEW_WORDS" >> $GITHUB_OUTPUT
            else
              echo "changes=+$TOTAL_WORDS" >> $GITHUB_OUTPUT
              echo "new_words=Initial index" >> $GITHUB_OUTPUT
            fi

            # Check for warnings
            WARNINGS=$(jq -r '.validation.warnings | length' _site/search-summary.json)
            if [ "$WARNINGS" -gt 0 ]; then
              echo "âš ï¸  Validation warnings found:"
              jq -r '.validation.warnings[]' _site/search-summary.json
            fi
          else
            echo "âš ï¸  No search summary found"
            exit 1
          fi

      - name: Check for changes
        id: check_changes
        run: |
          if [ -f "assets/search-data.json" ]; then
            # Compare old and new search data
            if ! diff -q assets/search-data.json _site/assets/search-data.json > /dev/null 2>&1; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸  No changes to search index"
            fi
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Copy search index to repository
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          mkdir -p assets
          cp _site/assets/search-data.json assets/search-data.json
          echo "âœ… Search index copied to assets/"

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add assets/search-data.json

          # Create detailed commit message
          COMMIT_MSG="ðŸ¤– Auto-update search index

ðŸ“Š Total vocabulary: ${{ steps.summary.outputs.total_words }} words
${{ steps.summary.outputs.changes >= 0 && 'âž•' || 'âž–' }} Changes: ${{ steps.summary.outputs.changes }} words
ðŸ†• New words: ${{ steps.summary.outputs.new_words }}

Updated sections: ${{ steps.summary.outputs.sections }}

Generated by GitHub Actions"

          git commit -m "$COMMIT_MSG"
          git push

          echo "âœ… Search index committed and pushed"

      - name: Create summary
        if: always()
        run: |
          echo "## Search Index Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š **Total Words:** ${{ steps.summary.outputs.total_words }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ steps.summary.outputs.changes >= 0 && 'âž•' || 'âž–' }} **Changes:** ${{ steps.summary.outputs.changes }} words" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ†• **New Words:** ${{ steps.summary.outputs.new_words }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ **Sections Updated:** ${{ steps.summary.outputs.sections }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Search index updated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸  No changes to search index" >> $GITHUB_STEP_SUMMARY
          fi
